#!/bin/sh

# configure script from SimpleInitGen.

echo "[ Getting Ready ]"
echo
echo -n "Deleting old makefile or makefile.notready file..."
if [ -f ./Makefile ]; then
	rm -f ./Makefile
	echo "ok."
else if [ -f ./Makefile.notready ]; then
	rm -f ./Makefile.notready
	echo "ok."
else
	echo "files dont exist."
fi
fi
echo -n "Deleting old init.c..."
if [ -f init.c ]; then
	rm -f init.c
	echo "ok."
else
	echo "file dosent exist."
fi
echo -n "checking if GCC is installed..."
if [ -f /usr/bin/gcc ]; then
	echo "ok."
else
	echo "no."
	echo "You must install GCC to compile!"
	echo "Install it by typing: sudo apt install gcc"
	exit 1
fi
echo -n "checking if Make is installed..."
if [ -f /usr/bin/make ]; then
	echo "ok."
else
	echo "no."
	echo "You must install Make to compile!"
	echo "Install it by typing: sudo apt install make"
	exit 1
fi
echo
echo "[ Options ]"
echo
read -p "Mount /dev? (Y/N): " mount_dev
if [ "$mount_dev" = "Y" ] || [ "$mount_dev" = "y" ]; then
	MOUNTDEV=1
else if [ "$mount_dev" = "N" ] || [ "$mount_dev" = "n" ]; then
	MOUNTDEV=0
else
	echo "Invalid answer! Quitting..."
	exit 1
fi
fi
read -p "Mount /proc? (Y/N): " mount_proc
if [ "$mount_proc" = "Y" ] || [ "$mount_proc" = "y" ]; then
	MOUNTPROC=1
else if [ "$mount_proc" = "N" ] || [ "$mount_proc" = "n" ]; then
	MOUNTPROC=0
else
	echo "Invalid answer! Quitting..."
	exit 1
fi
fi
read -p "Mount /sys? (Y/N): " mount_sys
if [ "$mount_sys" = "Y" ] || [ "$mount_sys" = "y" ]; then
	MOUNTSYS=1
else if [ "$mount_sys" = "N" ] || [ "$mount_sys" = "n" ]; then
	MOUNTSYS=0
else
	echo "Invalid answer! Quitting..."
	exit 1
fi
fi
read -p "Mount /tmp? (Y/N): " mount_tmp
if [ "$mount_tmp" = "Y" ] || [ "$mount_tmp" = "y" ]; then
	MOUNTTMP=1
else if [ "$mount_tmp" = "N" ] || [ "$mount_tmp" = "n" ]; then
	MOUNTTMP=0
else
	echo "Invalid answer! Quitting..."
	exit 1
fi
fi
read -p "Launch shell? (Y/N): " launch_shell
if [ "$launch_shell" = "Y" ] || [ "$launch_shell" = "y" ]; then
	LAUNCHSHELL=1
	read -p "   Enter shell path: " shell_path
	if [ -n "$shell_path" ]; then
		SHELLPATH=$shell_path
	else
		echo "Invalid answer! Quitting..."
		exit 1
	fi
	read -p "   Launch shell automatically when exited? (Y/N): " auto_launch
	if [ "$auto_launch" = "Y" ] || [ "$auto_launch" = "y" ]; then
		AUTOLAUNCH=1
	else if [ "$auto_launch" = "N" ] || [ "$auto_launch" = "n" ]; then
		AUTOLAUNCH=0
	else
		echo "Invalid answer! Quitting..."
		exit 1
	fi
	fi
else if [ "$launch_shell" = "N" ] || [ "$launch_shell" = "n" ]; then
	LAUNCHSHELL=0
else
	echo "Invalid answer! Quitting..."
	exit 1
fi
fi
read -p "Print verbose messages? (Y/N): " verbose
if [ "$verbose" = "Y" ] || [ "$verbose" = "y" ]; then
	VERBOSEMSG=1
else if [ "$verbose" = "N" ] || [ "$verbose" = "n" ]; then
	VERBOSEMSG=0
else
	echo "Invalid answer! Quitting..."
	exit 1
fi
fi
echo
echo "[ Creating Files ]"
echo
echo "Creating Makefile..."
echo "# Generated by SimpleInitGen." >> Makefile.notready
echo "CFLAGS = -static" >> Makefile.notready
echo "all: compile" >> Makefile.notready
echo "compile:" >> Makefile.notready
echo '	@gcc $(CFLAGS) -o init init.c' >> Makefile.notready
echo '	@echo "Generated init program, thanks for using SimpleInitGen!"' >> Makefile.notready
echo "clean:" >> Makefile.notready
echo '	@rm -f init' >> Makefile.notready
echo '	@echo "Cleaned, thanks for using SimpleInitGen!"' >> Makefile.notready
mv Makefile.notready Makefile
echo "Creating init.c..."
echo "// Generated by SimpleInitGen." >> init.c
echo "#include <stdio.h>" >> init.c
echo "#include <stdlib.h>" >> init.c
echo "#include <unistd.h>" >> init.c
echo "#include <sys/mount.h>" >> init.c
echo "#include <sys/wait.h>" >> init.c
echo "" >> init.c
echo "int main() {" >> init.c
printf '	printf("Init generated by SimpleInitGen.\\n");\n' >> init.c
if [ "$MOUNTDEV" = 1 ]; then
	if [ "$VERBOSEMSG" = 1 ]; then
		printf '	printf("Init: Mounting /dev...\\n");\n' >> init.c
	fi
	echo '	mount("devtmpfs", "/dev", "devtmpfs", 0, NULL);' >> init.c		
fi
if [ "$MOUNTPROC" = 1 ]; then
	if [ "$VERBOSEMSG" = 1 ]; then
		printf '	printf("Init: Mounting /proc...\\n");\n' >> init.c
	fi
	echo '	mount("proc", "/proc", "proc", 0, NULL);' >> init.c
fi
if [ "$MOUNTSYS" = 1 ]; then
	if [ "$VERBOSEMSG" = 1 ]; then
		printf '	printf("Init: Mounting /sys...\\n");\n' >> init.c
	fi
	echo '	mount("sysfs", "/sys", "sysfs", 0, NULL);' >> init.c
fi
if [ "$MOUNTTMP" = 1 ]; then
	if [ "$VERBOSEMSG" = 1 ]; then
		printf '	printf("Init: Mounting /tmp...\\n");\n' >> init.c
	fi
	echo '	mount("tmpfs", "/tmp", "tmpfs", 0, NULL);' >> init.c
fi
if [ "$LAUNCHSHELL" = 1 ]; then
	if [ "$AUTOLAUNCH" = 1 ]; then
		if [ "$VERBOSEMSG" = 1 ]; then
			printf '	printf("Init: Launching shell...\\n");\n' >> init.c
		fi
		echo '	while(1) {' >> init.c
		echo "		pid_t pid = fork();" >> init.c
		echo "		if (pid == 0) {" >> init.c
		echo "			execl(\"$SHELLPATH\", \"$SHELLPATH\", NULL);" >> init.c
		echo "			_exit(1);" >> init.c
		echo "		} else if (pid > 0) {" >> init.c
		echo "			int status;" >> init.c
		echo "			waitpid(pid, &status, 0);" >> init.c
		if [ "$VERBOSEMSG" = 1 ]; then
			printf '			printf("Init: Shell exited, relaunching...\\n");\n' >> init.c
		fi
		echo "		} else {" >> init.c
		echo "			sleep(1);" >> init.c
		echo "		}" >> init.c
		echo '	}' >> init.c
	else
		if [ "$VERBOSEMSG" = 1 ]; then
			printf '	printf("Init: Launching shell...\\n");\n' >> init.c
		fi
		echo "	execl(\"$SHELLPATH\", \"sh\", NULL);" >> init.c
	fi
fi
echo "	return 0;" >> init.c
echo "}" >> init.c
echo "Created both Makefile and init.c! Run 'make' to compile."
